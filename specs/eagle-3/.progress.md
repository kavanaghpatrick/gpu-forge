---
spec: eagle-3
basePath: specs/eagle-3
phase: complete
task: 28/28
updated: 2026-02-17
---

# Progress: eagle-3

## Original Goal

Implement EAGLE-3 speculative decoding for Mistral-7B GPU inference on Apple Silicon M4 Pro. Currently at 42.6 tok/s decode, target 100+ tok/s (2.43x speedup). EAGLE-3 adds a lightweight prediction head (~144MB Q4_0) attached to internal transformer layers that predicts draft tokens WITHOUT needing a separate draft model.

## Status: ALL TASKS COMPLETE (28/28)

### Phase 1: Make It Work (POC) - 9/9 tasks
- [x] 1.1 EagleCaptureBuffers and hidden state tap
- [x] 1.2 concat_buffers Metal shader
- [x] 1.3 EagleHead struct with random-weight init
- [x] 1.4 forward_draft_token GPU pipeline
- [x] 1.5 Quality checkpoint
- [x] 1.6 EagleDecoder with chain speculation loop
- [x] 1.7 Register eagle modules in lib.rs
- [x] 1.8 Quality checkpoint
- [x] 1.9 POC end-to-end test (20 tokens, 0% acceptance, no crashes)

### Phase 2: Weight Loading - 5/5 tasks
- [x] 2.1 SafeTensors parser
- [x] 2.2 EagleWeightStore with tensor name mapping
- [x] 2.3 EagleHead::from_weights() constructor
- [x] 2.4 Register eagle_weights module
- [x] 2.5 Quality checkpoint (220 unit tests pass)

### Phase 3: Testing - 5/5 tasks
- [x] 3.1 Hidden state capture correctness tests
- [x] 3.2 EagleHead forward pass tests
- [x] 3.3 Quality checkpoint (226 tests pass)
- [x] 3.4 Greedy output matches target-only decode
- [x] 3.5 EAGLE decode benchmark

### Phase 4: Quality Gates - 2/2 tasks
- [x] 4.1 Full local CI (fmt + clippy + build + tests)
- [x] 4.2 PR pushed to https://github.com/kavanaghpatrick/metal-attention/pull/2

### Phase 5: PR Lifecycle - 4/4 tasks (no CI/reviewers configured)
- [x] 5.1-5.4 All complete

## Key Deliverables

| File | Purpose |
|------|---------|
| eagle.rs | EagleDecoder with chain speculation loop |
| eagle_head.rs | EagleHead with forward_draft_token GPU pipeline |
| eagle_weights.rs | SafeTensors parser + EagleWeightStore |
| gpu_forward_pass.rs | EagleCaptureBuffers, hidden state tap at layers 0/NÃ·2/N-1 |
| concat_buffers.metal | Feature fusion kernels (2 and 3 input) |
| eagle_test.rs | 6 integration tests (all passing) |
| inference.rs | EAGLE decode benchmark |

## Test Results

- 220 workspace unit tests: PASS
- 6 eagle integration tests: PASS (62s)
  - Hidden state capture: valid, no NaN/Inf
  - Capture overhead: < 0.5ms/token
  - EagleHead produces valid token IDs (< 32000)
  - KV cache reset works
  - POC runs end-to-end (20 tokens)
  - Greedy output matches target-only decode exactly

## Next Steps (Future Specs)

- Train EAGLE-3 head weights for Mistral-7B (self-distillation)
- Q4_0 quantization for FC layers
- Tree-structured drafting (EAGLE-2 style)
- CLI --eagle flag integration
- Temperature > 0 speculative sampling
