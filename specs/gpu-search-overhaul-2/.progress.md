# Progress: gpu-search-overhaul-2

## Original Goal

Comprehensive gpu-search UI/UX overhaul. 5 issues from foreman spec analysis (see gpu-search/ai/tasks/spec/PM.md, TECH.md, QA.md, UX.md):

1. **STALE RESULTS BUG (P0)**: Race condition where debounce prefix searches leak stale results. Fix: generation-stamped SearchUpdate messages.
2. **RESULT FORMATTING**: Full absolute paths, fixed-height rows with unrelated content. Fix: grouped results with path abbreviation and compact/expandable rows.
3. **MATCH HIGHLIGHTING**: Highlighting doesn't show why a result matched. Fix: use match_range directly instead of re-searching.
4. **CPU VERIFICATION OFF**: VerifyMode defaults to "off". Fix: adaptive mode (Sample default, Full when <100 results).
5. **FLAT RESULT LIST**: No grouping, no visual hierarchy. Fix: always-expanded file groups with colored dots for file types.

Key decisions from foreman-spec Deep Mode Q&A (18 decisions across PM, UX, Tech, QA agents).

## Completed Tasks
- [x] 1.1 Add StampedUpdate struct and change channel types - 5d99b87
- [x] 1.2 Add generation guard to poll_updates() - 6fb63b1
- [x] 1.3 Change debounce from 30ms to 100ms - 6dacb2e
- [x] 1.4 Change VerifyMode default to Sample with adaptive effective() - PENDING_COMMIT
- [x] 1.5 Wire OpenFile, OpenInEditor, CopyPath actions - PENDING_COMMIT
- [x] 1.6 POC Checkpoint: verify stale results fix works end-to-end - PENDING_COMMIT
- [x] 2.1 Create path_utils.rs module with abbreviate_path() - 5137be0
- [x] 2.2 Add extension_dot_color() to theme.rs - 310d61c
- [x] 2.3 Add apply_match_range_overlay() to highlight.rs - a4ee123
- [x] 2.4 Add ContentGroup struct and incremental grouping logic - 4490e96

## Current Task
Awaiting next task

## Learnings
- Foreman-spec Deep Mode analysis (5 files, ~3000 lines) provided complete blueprint; synthesis was primarily extraction and restructuring, not discovery
- `dirs` crate already in Cargo.toml but TECH-Q2 decided `$HOME` env var for simplicity -- use OnceLock for caching
- `SyntaxHighlighter` borrow conflict is the trickiest Rust ownership issue; pass `&mut` parameter is cleanest solution (TECH-Q1)
- `results_list.rs` is the highest-risk file: near-complete rewrite from `show_rows()` to `show_viewport()` with RowKind model
- Dual test suites during migration is critical -- 11 existing tests depend on flat `selected_index` model that changes completely
- `SearchGeneration` already exists in `cancel.rs` -- the generation infrastructure is there, just not propagated to update messages
- `apply_match_overlay()` in highlight.rs already does span splitting; extracting `split_spans_at_ranges()` helper is a refactor, not new logic
- All action functions (open_file, open_in_editor) exist in actions.rs but are unconnected -- pure wiring task
- `ContentMatch.match_range` field exists and is populated by GPU but completely ignored by the renderer
- Channel type change (`SearchUpdate` -> `StampedUpdate`) cascades through orchestrator_thread signature and orchestrator.search_streaming -- handle all call sites
- `channel.rs` uses std `mpsc::Sender<SearchUpdate>` (separate from crossbeam streaming pipeline) -- does NOT need StampedUpdate conversion
- Orchestrator tests that read from update_rx need `stamped.update` unwrap pattern instead of direct `SearchUpdate` matching
- Generation guard is a simple `!=` check on `stamped.generation` vs `self.search_generation.current_id()` -- not `is_stale()` since we want exact match, not "newer than"
- `update_status_from_displayed()` runs after every poll loop to keep status bar in sync during progressive streaming
- Changed Complete handler to use `self.file_matches.len() + self.content_matches.len()` instead of `response.total_matches` so status bar always matches actual displayed count
- Pre-existing broken integration tests (test_root_search.rs, bench_search_scenarios.rs) need StampedUpdate unwrap fix from task 1.1 cascade -- use `--lib` flag to isolate unit tests
- `ResultsList` already had `get_selected()` and `get_selected_line()` helper methods from initial implementation -- wiring actions was purely connecting existing pieces
- egui 0.31 has `ctx.copy_text(text)` convenience method (wraps `output_mut(|o| o.copied_text = ...)`)
- Integration tests (test_root_search.rs, bench_search_scenarios.rs) needed StampedUpdate unwrap fix: `match update` -> `match stamped.update` after task 1.1 channel type change
- All 289 lib tests + 154 integration tests pass (excluding test_root_search which searches from `/` and takes many minutes)
- `Path::new("file.txt").parent()` returns `Some("")` not `None` -- must check `is_empty()` on parent's OsStr
- `abbreviate_path` returns owned `(String, String)` -- `render_file_row()` needs `search_root` threaded through `show()` -> `show_file_matches()` -> `render_file_row()`
- `OnceLock<Option<PathBuf>>` for HOME caching works perfectly -- single static, initialized on first access

- `split_spans_at_ranges()` indexes into `span.text` using relative offsets `(cursor - span_start)` rather than indexing `original_line` -- this makes it independent of the original line text, working purely on span text content
- Refactored `apply_match_overlay()` to delegate to `split_spans_at_ranges()` -- all 14 existing highlight tests continue to pass
- `Complete` handler replaces `content_matches` entirely, so must `clear_groups()` before `recompute_groups()` to avoid stale group state; `ContentMatches` is incremental (extend) so just appends to existing groups
- `sort_groups_by_count()` must rebuild `group_index_map` after sorting since indices change -- needed for future incremental appends (though in practice groups are cleared before next search)

## Next
Task 2.5: Add RowKind enum, FlatRowModel, and rebuild logic
