# Progress: gpu-search-overhaul-2

## Original Goal

Comprehensive gpu-search UI/UX overhaul. 5 issues from foreman spec analysis (see gpu-search/ai/tasks/spec/PM.md, TECH.md, QA.md, UX.md):

1. **STALE RESULTS BUG (P0)**: Race condition where debounce prefix searches leak stale results. Fix: generation-stamped SearchUpdate messages.
2. **RESULT FORMATTING**: Full absolute paths, fixed-height rows with unrelated content. Fix: grouped results with path abbreviation and compact/expandable rows.
3. **MATCH HIGHLIGHTING**: Highlighting doesn't show why a result matched. Fix: use match_range directly instead of re-searching.
4. **CPU VERIFICATION OFF**: VerifyMode defaults to "off". Fix: adaptive mode (Sample default, Full when <100 results).
5. **FLAT RESULT LIST**: No grouping, no visual hierarchy. Fix: always-expanded file groups with colored dots for file types.

Key decisions from foreman-spec Deep Mode Q&A (18 decisions across PM, UX, Tech, QA agents).

## Completed Tasks
- [x] 1.1 Add StampedUpdate struct and change channel types - 5d99b87
- [x] 1.2 Add generation guard to poll_updates() - 6fb63b1
- [x] 1.3 Change debounce from 30ms to 100ms - 6dacb2e
- [x] 1.4 Change VerifyMode default to Sample with adaptive effective() - PENDING_COMMIT
- [x] 1.5 Wire OpenFile, OpenInEditor, CopyPath actions - PENDING_COMMIT
- [x] 1.6 POC Checkpoint: verify stale results fix works end-to-end - PENDING_COMMIT
- [x] 2.1 Create path_utils.rs module with abbreviate_path() - 5137be0
- [x] 2.2 Add extension_dot_color() to theme.rs - 310d61c
- [x] 2.3 Add apply_match_range_overlay() to highlight.rs - a4ee123
- [x] 2.4 Add ContentGroup struct and incremental grouping logic - 4490e96
- [x] 2.5 Add RowKind enum, FlatRowModel, and rebuild logic - fcb6979
- [x] 2.6 Replace show_rows() with show_viewport() grouped rendering - PENDING_COMMIT
- [x] 2.7 Update status bar with searching state and live count - PENDING_COMMIT

- [x] 2.8 Add hover tooltip and Tab section jump - 551e403
- [x] 3.1 Unit tests for StampedUpdate generation filtering - 5c9549d
- [x] 3.2 Unit tests for path abbreviation - fa8f959
- [x] 3.3 Unit tests for ContentGroup building and sorting - 0e252aa
- [x] 3.5 Unit tests for adaptive VerifyMode - 63b105e
- [x] 3.6 Unit tests for match_range overlay - 8c99d23
- [x] 3.4 Unit tests for RowKind flattening and prefix-sum heights - 059a559
- [x] 3.7 Integration tests for stale result filtering - 393f9db
- [x] 3.8 Integration tests for navigation and row expansion - 7c295f1
- [x] 3.9 Unit tests for extension dot colors and status bar - 76cdd36

## Current Task
Phase 3 Testing in progress

## Learnings
- Foreman-spec Deep Mode analysis (5 files, ~3000 lines) provided complete blueprint; synthesis was primarily extraction and restructuring, not discovery
- `dirs` crate already in Cargo.toml but TECH-Q2 decided `$HOME` env var for simplicity -- use OnceLock for caching
- `SyntaxHighlighter` borrow conflict is the trickiest Rust ownership issue; pass `&mut` parameter is cleanest solution (TECH-Q1)
- `results_list.rs` is the highest-risk file: near-complete rewrite from `show_rows()` to `show_viewport()` with RowKind model
- Dual test suites during migration is critical -- 11 existing tests depend on flat `selected_index` model that changes completely
- `SearchGeneration` already exists in `cancel.rs` -- the generation infrastructure is there, just not propagated to update messages
- `apply_match_overlay()` in highlight.rs already does span splitting; extracting `split_spans_at_ranges()` helper is a refactor, not new logic
- All action functions (open_file, open_in_editor) exist in actions.rs but are unconnected -- pure wiring task
- `ContentMatch.match_range` field exists and is populated by GPU but completely ignored by the renderer
- Channel type change (`SearchUpdate` -> `StampedUpdate`) cascades through orchestrator_thread signature and orchestrator.search_streaming -- handle all call sites
- `channel.rs` uses std `mpsc::Sender<SearchUpdate>` (separate from crossbeam streaming pipeline) -- does NOT need StampedUpdate conversion
- Orchestrator tests that read from update_rx need `stamped.update` unwrap pattern instead of direct `SearchUpdate` matching
- Generation guard is a simple `!=` check on `stamped.generation` vs `self.search_generation.current_id()` -- not `is_stale()` since we want exact match, not "newer than"
- `update_status_from_displayed()` runs after every poll loop to keep status bar in sync during progressive streaming
- Changed Complete handler to use `self.file_matches.len() + self.content_matches.len()` instead of `response.total_matches` so status bar always matches actual displayed count
- Pre-existing broken integration tests (test_root_search.rs, bench_search_scenarios.rs) need StampedUpdate unwrap fix from task 1.1 cascade -- use `--lib` flag to isolate unit tests
- `ResultsList` already had `get_selected()` and `get_selected_line()` helper methods from initial implementation -- wiring actions was purely connecting existing pieces
- egui 0.31 has `ctx.copy_text(text)` convenience method (wraps `output_mut(|o| o.copied_text = ...)`)
- Integration tests (test_root_search.rs, bench_search_scenarios.rs) needed StampedUpdate unwrap fix: `match update` -> `match stamped.update` after task 1.1 channel type change
- All 289 lib tests + 154 integration tests pass (excluding test_root_search which searches from `/` and takes many minutes)
- `Path::new("file.txt").parent()` returns `Some("")` not `None` -- must check `is_empty()` on parent's OsStr
- `abbreviate_path` returns owned `(String, String)` -- `render_file_row()` needs `search_root` threaded through `show()` -> `show_file_matches()` -> `render_file_row()`
- `OnceLock<Option<PathBuf>>` for HOME caching works perfectly -- single static, initialized on first access

- `split_spans_at_ranges()` indexes into `span.text` using relative offsets `(cursor - span_start)` rather than indexing `original_line` -- this makes it independent of the original line text, working purely on span text content
- Refactored `apply_match_overlay()` to delegate to `split_spans_at_ranges()` -- all 14 existing highlight tests continue to pass
- `Complete` handler replaces `content_matches` entirely, so must `clear_groups()` before `recompute_groups()` to avoid stale group state; `ContentMatches` is incremental (extend) so just appends to existing groups
- `sort_groups_by_count()` must rebuild `group_index_map` after sorting since indices change -- needed for future incremental appends (though in practice groups are cleared before next search)
- `FlatRowModel::rebuild()` takes `selected_row_idx: Option<usize>` (flat model index, not old `selected_index`) to expand selected MatchRow to 52px; FileMatchRow always 24px
- `cum_heights.partition_point(|&h| h <= viewport_top)` gives first row whose bottom extends past viewport_top -- exact O(log n) binary search
- `next_selectable_row`/`prev_selectable_row` wrap around and skip SectionHeader + GroupHeader rows
- egui `show_viewport()` callback receives `Rect` of visible area; use `ui.set_height(total)` to tell egui the full scroll extent (not `inner_content_size`)
- egui `show_rows()` uses `show_viewport()` internally -- pattern is: `ui.set_height()` + `ui.allocate_new_ui(UiBuilder::new().max_rect(rect), ...)` for positioning rows at correct y offset
- Render functions extracted to free functions (`render_section_header`, `render_group_header`, `render_match_row`, `render_file_row`, `render_styled_spans`) to avoid `&mut self` borrow conflicts with highlighter
- `paint_selected_bg()` helper extracts duplicated selection highlight + accent border painting
- `FlatRowModel` must be rebuilt after every result update (FileMatches, ContentMatches, Complete) and stored on `GpuSearchApp`
- Old `show_file_matches()` and `show_content_matches()` removed; unified `show()` handles all row types through `RowKind` match
- `_highlighter` renamed to `highlighter` and passed as `&mut SyntaxHighlighter` to `show()` -- resolves TECH-Q1 borrow conflict
- All 322 lib tests pass after the rewrite -- existing tests still work because `select_next/prev`, `get_selected`, `get_selected_line` kept their old signatures
- `render_match_row()` uses `highlighter.highlight_line()` + `apply_match_range_overlay()` + `render_styled_spans()` pipeline for syntax + match highlighting

- `StatusBar` now has `is_searching: bool` and `search_start: Option<Instant>` -- render() and format_status() branch on is_searching to show live vs final state
- Live elapsed uses `Instant::now()` set in `dispatch_search()`, cleared on `Complete` -- `search_start` is `Option` to handle the no-start edge case gracefully
- `status_bar.is_searching` is set in 3 places: `true` in dispatch_search, `false` on Complete, `false` on empty query clear
- Format changed from integer ms to `{:.1}ms` (e.g., "12.0ms") for consistency with searching state's `{:.1}s`

- `render_group_header()` changed from returning `()` to returning `egui::Response` for `.on_hover_text()` -- had to change `_response` to `response` and add return
- `CycleFilter` keybind replaced with `JumpToContentSection` (Tab) and `JumpToFileSection` (Shift+Tab) -- `ModifierState` gained `shift` field
- `FlatRowModel::first_selectable_in_content_section()` and `first_selectable_in_file_section()` search for section headers then find first selectable row after them
- After section jump, must call `rebuild_flat_model()` so the newly selected row gets expanded height

## Next
Task 4.1: Run full regression test suite
