# Progress: gpu-search-overhaul-2

## Original Goal

Comprehensive gpu-search UI/UX overhaul. 5 issues from foreman spec analysis (see gpu-search/ai/tasks/spec/PM.md, TECH.md, QA.md, UX.md):

1. **STALE RESULTS BUG (P0)**: Race condition where debounce prefix searches leak stale results. Fix: generation-stamped SearchUpdate messages.
2. **RESULT FORMATTING**: Full absolute paths, fixed-height rows with unrelated content. Fix: grouped results with path abbreviation and compact/expandable rows.
3. **MATCH HIGHLIGHTING**: Highlighting doesn't show why a result matched. Fix: use match_range directly instead of re-searching.
4. **CPU VERIFICATION OFF**: VerifyMode defaults to "off". Fix: adaptive mode (Sample default, Full when <100 results).
5. **FLAT RESULT LIST**: No grouping, no visual hierarchy. Fix: always-expanded file groups with colored dots for file types.

Key decisions from foreman-spec Deep Mode Q&A (18 decisions across PM, UX, Tech, QA agents).

## Current Phase
execution

## Learnings
- Foreman-spec Deep Mode analysis (5 files, ~3000 lines) provided complete blueprint; synthesis was primarily extraction and restructuring, not discovery
- `dirs` crate already in Cargo.toml but TECH-Q2 decided `$HOME` env var for simplicity -- use OnceLock for caching
- `SyntaxHighlighter` borrow conflict is the trickiest Rust ownership issue; pass `&mut` parameter is cleanest solution (TECH-Q1)
- `results_list.rs` is the highest-risk file: near-complete rewrite from `show_rows()` to `show_viewport()` with RowKind model
- Dual test suites during migration is critical -- 11 existing tests depend on flat `selected_index` model that changes completely
- `SearchGeneration` already exists in `cancel.rs` -- the generation infrastructure is there, just not propagated to update messages
- `apply_match_overlay()` in highlight.rs already does span splitting; extracting `split_spans_at_ranges()` helper is a refactor, not new logic
- All action functions (open_file, open_in_editor) exist in actions.rs but are unconnected -- pure wiring task
- `ContentMatch.match_range` field exists and is populated by GPU but completely ignored by the renderer
- Channel type change (`SearchUpdate` -> `StampedUpdate`) cascades through orchestrator_thread signature and orchestrator.search_streaming -- handle all call sites
