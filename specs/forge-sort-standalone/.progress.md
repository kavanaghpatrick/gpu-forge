---
spec: forge-sort-standalone
basePath: ./specs/forge-sort-standalone
phase: tasks
task: 1/7
updated: 2026-02-20
---

# Progress: forge-sort-standalone

## Original Goal

Inline forge-primitives into forge-sort to make it a self-contained crate. forge-sort only uses PsoCache+FnConstant (191 lines), device/queue init from MetalContext (10 lines), and alloc_buffer (8 lines) from forge-primitives. Create metal_helpers.rs with these inlined, remove the path dependency, verify 165 tests pass.

## Completed Tasks

- [x] 1.1 Create metal_helpers.rs with inlined code - 69840054c
- [x] 1.2 Update lib.rs imports and GpuSorter::new() - c3c12ac9d

## Current Task

Awaiting next task

## Learnings

- forge-sort uses MetalContext ONLY for device+queue; discards the library field entirely (loads own metallib via env!("SORT_METALLIB_PATH"))
- Only 2 import lines in lib.rs reference forge-primitives: line 4 (FnConstant) and line 5 (alloc_buffer, MetalContext, PsoCache)
- alloc_buffer used ~20 times throughout lib.rs for buffer allocation
- PsoCache + FnConstant used extensively (40+ references) for PSO specialization
- forge-bench is the only other consumer of forge-primitives in the workspace -- completely independent
- No new Cargo.toml dependencies needed; objc2/objc2-metal/objc2-foundation already present in forge-sort
- MTLCreateSystemDefaultDevice import needed from objc2_metal (already a dep)
- PsoCache has 94 lines of unit tests (key building); recommend NOT copying since they exist in forge-primitives
- GpuSorter::new() at line 559: uses MetalContext::new() then ctx.device/ctx.queue -- simple tuple destructure replacement
- PsoCache source is 191 lines (lines 1-191 of pso_cache.rs), tests are 93 lines (193-285) -- skip tests
- alloc_buffer is 9 lines total including fn signature
- metal_helpers.rs needs MTLCreateSystemDefaultDevice + MTLResourceOptions imports beyond what pso_cache.rs uses
- build.rs is fully independent of forge-primitives (only uses std + xcrun)
- lib.rs line 2 `use std::ptr::NonNull` already exists -- metal_helpers.rs needs its own since it's a separate module
- Task planning: 7 tasks total (4 POC + 2 quality + 1 PR lifecycle). Trivial refactor, no test/refactor phases needed.
- MTLResourceOptions not imported in lib.rs -- only needed inside metal_helpers.rs
- forge-sort README.md line 218 mentions forge-primitives (docs only, non-blocking)

## Blockers

- None currently

## Next

Task 1.3: Remove forge-primitives dependency from Cargo.toml
