# gpu-forge-harness-wiring

## Original Goal
Wire up all disconnected workflows in the gpu-forge Claude Code plugin. Fix 8 identified gaps: (1) 98 orphaned investigations stuck in 'running' - add mandatory log-end to investigation-agent, (2) citation coverage at 6.6% - add citation enforcement to investigation protocol, (3) 95 findings missing source URLs - add DB constraint + backfill, (4) post-edit hook only catches 1/10 MSL issues - expand to check address spaces, threadgroup sizes, barriers, bank conflicts, (5) no review→KB feedback loop - add write-back when review finds new anti-patterns, (6) architecture-advisor agent has no slash command - add /gpu-forge:advise, (7) scaffold command disconnected from JSON template configs - wire wizard to project JSON scaffolds, (8) investigation tracking broken with 98 stale sessions - add cleanup mechanism. All changes are within the gpu-forge plugin at /Users/patrickkavanagh/gpu_kernel/.

## Interview Format
- Version: 1.0

## Intent Classification
- Type: REFACTOR
- Confidence: high (4 keywords matched)
- Min questions: 3
- Max questions: 5
- Keywords matched: wire, fix, add, expand

## Interview Responses

### Goal Interview (from start.md)
- Problem: Plugin features exist but don't connect end-to-end — individual components work, but workflows break at handoff points
- Constraints: Must pass all 194 existing BATS tests — zero test regressions, only additive changes
- Success criteria: Both — all 8 audit gaps closed AND new end-to-end workflow integration tests added

### Requirements Interview (from requirements.md)
- Primary users: Open-source community — external developers will install and use gpu-forge
- Priority tradeoffs: Prioritize code quality and maintainability — clean implementation that's easy to extend

### Design Interview (from design.md)
- Architecture style: Extend existing architecture — add to current hooks.json, scripts/kb, commands/, follow established patterns
- Technology constraints: Allow Python for complex checks — use Python for post-edit hook or KB tooling if bash gets unwieldy
- Integration approach: Use existing APIs and interfaces (hooks.json, scripts/kb, commands/ patterns)

### Tasks Interview (from tasks.md)
- Testing depth: Comprehensive — include E2E with all 16 new harness-wiring.bats tests
- Execution priority: Quality first — each gap fully implemented with tests before moving to next

## Completed Tasks
- [x] 0.1 Fix hooks.bats for nested object format
- [x] 1.1 Add kb cleanup subcommand
- [x] 1.2 Add stale investigation check to kb verify
- [x] 2.1 Create investigation-cleanup.sh hook script
- [x] 2.2 Add SubagentStop entry to hooks.json
- [x] 2.3 Add SubagentStop test to hooks.bats

## Current Task
Awaiting next task

## Next
Task 2.4 [VERIFY] Quality checkpoint after Gap 8 + Gap 1

## Learnings
- Actual test count is 196 (not 194 as stated in goal) -- all passing as of 2026-02-20
- Citation coverage: 6.6% is misleading. Real metric is 41.4% of academic papers have citations (213/515). 302 academic findings lack citations.
- 95 URL-less findings are ALL benchmark (14) + empirical_test (81) -- local experiments, not web research. Adding NOT NULL constraint would break legitimate use cases.
- SubagentStop hook is the right mechanism for cleanup -- fires when ANY subagent finishes, including timeout/error. Matcher supports agent name filtering.
- hooks.json uses nested object format `{"hooks": {"EventName": [...]}}` not array format. Plugin hooks merge with user/project hooks automatically.
- The scaffold command's JSON configs in templates/project/ are fully valid and well-structured (tested by templates.bats) but completely ignored by scaffold.md -- two independent implementations.
- `commands.bats` hardcodes `all 6 command files exist` by name -- adding advise.md requires updating this test.
- `kb verify` already checks for missing URLs but doesn't distinguish web-source vs local-experiment findings.
- The `context: fork` + `agent: investigation-agent` pattern is the canonical way to delegate from commands to agents.
- 1186 findings (33%) have no investigation_session linkage (investigation_session='0' or NULL or empty) -- these predate the investigation tracking system.
- PostToolUse hooks can return `additionalContext` to Claude but CANNOT block edits (tool already ran). The hook's `hookSpecificOutput` is informational only.
- commands.bats has 6 separate loop-based tests that ALL enumerate command names -- adding `advise` requires updating every loop, not just the count test title. This is the highest-risk test regression point.
- Scaffold has 5 JSON configs but no `histogram-kernel.json` or `benchmark-harness.json` -- fallback to `metal-compute-blank.json` needed for unmapped pattern+language combinations.
- Gap dependency chain: Gap 8 (cleanup) -> Gap 1 (SubagentStop hook) -> Gap 2 (citations). Gaps 3-7 are independent and parallelizable.
- Post-edit hook currently only fires on `Edit` tool, not `Write` -- hooks.json matcher must add a second PostToolUse entry for `Write` tool.
- Review command already has Bash in allowed-tools -- adding KB write-back is a prompt-only change, no hooks.json modification needed.
- 8 user stories map 1:1 to 8 gaps. 20 functional requirements with clear P1/P2/P3 priorities. P1 items: cleanup, SubagentStop, hook expansion, advise command, scaffold wiring, test updates.
- CRITICAL: hooks.bats has 4 FAILING tests (not 0) -- tests expect old array format `[{event: "SessionStart"}]` but hooks.json uses nested object format `{"SessionStart": [...]}`. These must be fixed as a prerequisite before extending hooks.json.
- Total pre-existing failures: 7 tests (4 hooks format, 2 golden queries, 1 DB size). The "196 all passing" claim from research is incorrect.
- `--hours 0` trick for SubagentStop: `datetime('now', '-0 hours')` equals `datetime('now')`, so it catches ALL running investigations regardless of age. Safe because hook only fires at agent termination.
- Post-edit hook stays bash (not Python): all 6 new checks are simple grep/regex patterns. Python would add startup overhead (~50ms) that eats into the 200ms budget.
- INFO vs WARNING distinction for verify URL check: benchmark/empirical_test missing URLs are INFO (don't increment issue count), web-source missing URLs are ERROR. Prevents false-positive noise.
- Scaffold JSON configs have consistent structure: `name`, `description`, `parameters` (with types/defaults/options), `files` (template->output mappings), `knowledge_applied` (skill names). All 5 follow same schema.
- commands.bats has exactly 5 loops enumerating command names (lines 13, 19, 25, 31, 65) plus the title on line 12. All must be updated for `advise`.
- Design produces 11 implementation steps with clear dependency ordering. 5 files modified, 3 files created. Estimated ~400 lines of changes across all files.
- Task planning: 28 tasks across 6 phases. Quality-first approach means each gap is fully tested before moving to next.
- Task planning: scripts/kb verify) case ends at line ~350 -- Check 5 is at lines 335-342, summary echo at 344. New checks 6 and 7 must go between Check 5 and summary.
- Task planning: investigation-agent.md Phase 3 ends at ~118, Phase 4 Citations starts at ~120. Merge requires keeping Phase 3 content + appending citation protocol + deleting Phase 4 + renumbering Phase 5.
- Task planning: Two files get modified by multiple tasks (scripts/kb: tasks 1.1+1.2+5.1+5.2+7.2; investigation-agent.md: tasks 5.3+7.1). Executor must read fresh file state before each edit.
- Task planning: hooks.json gets modified twice (tasks 2.2+4.2). SubagentStop added first, Write matcher second. Both are additive to the `.hooks` object.
- Task planning: Verify commands use absolute paths throughout since agent cwd may vary between bash calls.
- kb verify Check 6 WARNING text says "investigations running for >1 hour" (not "stale investigations"), so task verify grep matches only the else branch ("No stale investigations"). Both branches confirm the check is present.

### Verification: 1.3 [VERIFY] Quality checkpoint after core kb changes
- Status: PASS
- Commands: bats tests/unit/hooks.bats (exit 0, 9/9 pass), bats tests/unit/kb-cli.bats (exit 0, 20/20 pass)
- Total: 29 tests, 0 failures, 0 skipped
- Regressions: None detected

### Verification: 2.4 [VERIFY] Quality checkpoint after Gap 8 + Gap 1
- Status: PASS
- Commands: bats /Users/patrickkavanagh/gpu_kernel/tests/unit/ (exit 0, 119/119 pass)
- Total: 119 tests, 0 failures, 0 skipped
- Regressions: None detected after hooks.json changes and investigation-cleanup.sh addition
