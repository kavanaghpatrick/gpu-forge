## Reality Check (BEFORE)

**Goal type**: Fix
**Reproduction command**: `cargo bench --bench inference`
**Exit code**: 0
**Benchmark output**:
```
decode_throughput/gpu_decode_100tok
                        time:   [413.06 ms 417.31 ms 424.54 ms]
                        thrpt:  [235.55  elem/s 239.63  elem/s 242.10  elem/s]

decode_throughput/cpu_decode_100tok
                        time:   [6.1121 s 6.1772 s 6.2483 s]
                        thrpt:  [16.004  elem/s 16.189  elem/s 16.361  elem/s]
```

**Key metrics to improve**:
- GPU decode: ~240 tok/s (BEFORE) -> target >500 tok/s (AFTER)
- Q4_0 read bandwidth: ~1.5 GB/s (BEFORE) -> target >50 GB/s (AFTER)

## Learnings

- BlockQ4_0 struct is 18 bytes but Metal reads are most efficient at 16-byte (uint4) alignment
- 7 blocks x 18 bytes = 126 bytes fits neatly in 8 x uint4 = 128 bytes (1 cache line)
- Existing v2/v3/v4 experiments all still read via BlockQ4_0 struct -- none addressed the alignment issue
- v3_multirow (256 threads, threadgroup partial_sums) is the pattern to follow for multi-row
- Forward pass has two encode methods: encode_matvec_q4_0 (standalone) and encode_fused_rmsnorm_matvec_q4_0 (with inline RMS) -- both need updating
- SmolLM-135M uses tied embeddings (F32 lm_head), so lm_head matvec uses encode_matvec_f32 -- NOT affected by this fix
- PsoKey::simple("name") + prewarm list is the standard way to register kernels
- n_blocks_per_row = 18 for most projections (576/32), 48 for down (1536/32)
- cargo clean -p metal-attention-kernels may be needed when adding new .metal files
