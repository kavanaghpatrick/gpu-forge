---
spec: forge-ci
basePath: ./specs/forge-ci
phase: requirements
task: 0/0
updated: 2026-02-20
---

# Progress: forge-ci

## Original Goal

Set up GitHub Actions CI/CD for the metal-forge-compute workspace. Create forge-ci.yml workflow with 3 jobs: checks (clippy+check+tests on macos-14), perf (feature-gated perf tests on main only), build (release binary). Fix existing test.yml to remove || true that swallows BATS test failures. All Metal code requires macos-14 runners. forge-sort has 165 tests (--test-threads=1), forge-primitives has 40 tests. Use MTL_SHADER_VALIDATION=1 env.

## Completed Tasks

- [x] 1.1 Create forge-ci.yml workflow
- [x] 1.2 Fix test.yml -- remove `|| true` from BATS steps

## Current Task

Awaiting next task

## Learnings

- test.yml has `|| true` on 3 of 4 BATS steps (unit, integration, performance) -- the final "full suite" step already runs without it, so it catches failures but only after redundant earlier steps pass silently
- forge-bench has a `main.rs` binary (CLI harness with clap) -- the build artifact to upload
- No `[[bin]]` overrides in any Cargo.toml -- binary names match crate names (forge-bench)
- Workspace Cargo.lock exists at `metal-forge-compute/Cargo.lock` -- use for cache key
- gpu-search-ci.yml is a proven reference: 5-stage pipeline, same toolchain/cache/artifact pattern
- forge-sort perf tests are feature-gated behind `perf-test` feature (Cargo.toml confirmed)
- All 3 crates depend on objc2-metal 0.3 -- macos-14 (ARM) is non-negotiable
- Single shared cache key (`forge-cargo`) is sufficient -- all 3 jobs use same workspace deps, unlike gpu-search which has divergent bench/test dependencies
- forge-primitives tests can run in parallel (default) -- only forge-sort needs --test-threads=1 for Metal device contention
- MTL_SHADER_VALIDATION at workflow level (not per-step) covers all test invocations cleanly

## Blockers

- None currently

## Learnings

- Task planning: only 5 tasks total (2 create/edit + 3 verify) -- trivial spec, no POC phasing needed
- No actionlint or yamllint installed -- using `python3 -c "import yaml; yaml.safe_load(...)"` for YAML validation
- forge-ci.yml YAML is fully specified in design.md -- executor should copy exactly, no improvisation
- test.yml has exactly 3 occurrences of `|| true` on lines 33, 38, 43 -- simple string replacement
- Verification is all grep-based: count macos-14 (3), count needs: checks (2), count test-threads=1 (2), count || true (0)

## Next

Awaiting next task

### Verification: 2.1 [VERIFY] Validate both workflow files
- Status: PASS
- YAML syntax forge-ci.yml: PASS (python3 yaml.safe_load)
- YAML syntax test.yml: PASS (python3 yaml.safe_load)
- forge-ci.yml 3 jobs (checks, perf, build): PASS
- All 3 jobs use macos-14: PASS (grep count = 3)
- perf needs: checks + if: gate (main/dispatch): PASS
- build needs: checks: PASS
- Cache key matches expected pattern: PASS (3 occurrences, all correct)
- --test-threads=1 present: PASS (grep count = 2)
- upload-artifact@v4 with forge-bench-macos-arm64: PASS
- test.yml no || true in BATS steps: PASS (grep count = 0)
- test.yml bats tests/ step unchanged: PASS

### Verification: 2.3 [VERIFY] AC checklist
- Status: PASS
- FR-1.1 workflow_dispatch trigger: PASS (found in forge-ci.yml)
- FR-1.2 macos-14 runner count: PASS (grep -c = 3, expected 3)
- FR-1.3 working-directory default: PASS (working-directory: metal-forge-compute)
- FR-1.4 RUSTFLAGS -D warnings: PASS (RUSTFLAGS: -D warnings in env)
- FR-2.3 clippy --workspace: PASS (cargo clippy --workspace -- -D warnings)
- FR-2.5 test -p forge-primitives: PASS (cargo test -p forge-primitives)
- FR-2.6 test -p forge-sort + test-threads=1: PASS (both present, 2 occurrences)
- FR-3.1 refs/heads/main gate: PASS (if: github.ref == 'refs/heads/main')
- FR-3.3 features perf-test: PASS (--release --features perf-test)
- FR-4.3 upload-artifact@v4: PASS (actions/upload-artifact@v4)
- FR-5 no || true in test.yml: PASS (grep -c = 0, expected 0)
- All 11 ACs verified: PASS
