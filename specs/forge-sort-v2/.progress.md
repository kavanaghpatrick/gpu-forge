---
spec: forge-sort-v2
basePath: ./specs/forge-sort-v2
phase: requirements
task: 0/0
updated: 2026-02-20
---

# Progress: forge-sort-v2

## Original Goal

Add i32, f32, u64, i64, f64, argsort, and key-value pair sorting to forge-sort GPU radix sort library. Extend Metal shaders with function constants (HAS_VALUES, IS_64BIT), GPU-side bit transforms (FloatFlip/XOR), sealed SortKey trait, generic SortBuffer<T>. 3 phases: Phase 1 (i32/f32 transforms), Phase 2 (argsort/KV with index init + gather kernels), Phase 3 (64-bit pipeline with 8 passes). Target 2800+ Mk/s for 32-bit, 800+ Mk/s for 64-bit. Full foreman spec already complete at metal-forge-compute/forge-sort/ai/tasks/spec/.

## Completed Tasks
- [x] 1.1 Extend PsoCache with function constant support
- [x] 1.2 Add SortKey sealed trait and make SortBuffer generic
- [x] 1.3 Update existing tests for SortBuffer<u32> annotation
- [x] V1 [VERIFY] Quality checkpoint: cargo check + existing tests
- [x] 1.4 Add sort_transform_32 kernel + function constant declarations to sort.metal
- [x] 1.5 Implement sort_i32 and sort_i32_buffer methods
- [x] 1.6 Implement sort_f32 and sort_f32_buffer methods
- [x] 1.7 Add i32/f32 correctness tests
- [x] V2 [VERIFY] Quality checkpoint: full test suite
- [x] 1.8 POC Checkpoint: verify i32/f32 sort end-to-end

- [x] 2.1 Add InnerParams struct and refactor sort_inner_fused binding
- [x] 2.2 Add HAS_VALUES branches to sort_msd_atomic_scatter
- [x] 2.3 Add HAS_VALUES branches to sort_inner_fused

## Current Task

Awaiting next task

## Learnings

- Foreman spec is comprehensive (5 files, ~5000 lines). PM/UX/TECH/QA aligned on all 13 key decisions.
- v1 has 26 tests in correctness.rs (18 integration + 3 unit + 5 buffer). All reference untyped SortBuffer.
- v1 lib.rs is 479 lines, sort.metal is 439 lines. dispatch_sort() is monolithic -- needs refactoring for SortPipelineConfig.
- sort_inner_fused currently takes bare `constant uint& batch_start [[buffer(3)]]` -- must change to InnerParams struct (breaking for kernel but we control all callers).
- PsoCache in forge-primitives has no function constant support -- must add FnConstant + get_or_create_specialized().
- i64 XOR sign-bit transform is mathematically identical to FloatFlip formula applied to two's-complement integers -- can share TRANSFORM_MODE=1 with f64 forward.
- 64-bit tile size (2048) keeps register budget at ~40/48 regs (well within M4's 96 limit).
- No build.rs changes needed: function constants resolve at PSO creation time, not shader compile time.
- Function constants with defaults (is_function_constant_defined ternary) compile cleanly in Metal -- existing kernels unaffected when constants not set. sort_transform_32 uses transform_mode function constant for mode dispatch.
- v1 SortBuffer has no PhantomData -- adding it for SortBuffer\<T\> is purely additive to the struct layout.
- sort_pairs Strategy B needs 5 n-sized buffers (320 MB @ 16M) vs Strategy A's 4 (256 MB). Extra gather dispatch is the tradeoff.
- Design phase: dispatch_sort_pipeline buffer ping-pong for 64-bit requires swapping kernel arguments (buf_a, buf_b) between dispatches, not just tracking a boolean. Inner kernel pass 0 always reads from its second buffer param.
- Design phase: PsoCache cache key format "fn_name:idx=val:idx=val" is sufficient -- no hash needed, string concatenation with constants is unique.
- Design phase: 11 eager PSOs + 7 lazy PSOs = 18 total. 64-bit lazy to avoid penalizing GpuSorter::new() startup time for users who only sort 32-bit.
- Design phase: sort.metal grows from 439 to ~560 lines. If lib.rs exceeds ~800 lines in Phase 2, consider extracting pipeline.rs and types.rs -- but defer until clearly needed.
- Option B approach for transforms: created `encode_sort_pipeline()` + `encode_transform_32()` free functions that take an encoder parameter, keeping `dispatch_sort()` untouched for u32 backward compat. i32/f32 use single cmd buffer with transform+sort+inverse_transform. `dispatchThreads_threadsPerThreadgroup` works for 1D transform kernel.
- Design phase: InnerParams struct change to sort_inner_fused is the only breaking kernel signature change. All other modifications are additive (new function constant branches, new kernels).
- PsoCache FnConstant uses string-based cache key "fn_name:idx=val" (simpler than attention-proto's PsoKey struct). Bool values serialized as 0/1 in the key string. NonNull pointer creation for setConstantValue_type_atIndex requires `&*b as *const bool as *mut c_void` pattern for borrow references.
- SortBuffer<T> generic change is fully backward-compatible: existing tests don't need changes because Rust infers T=u32 from sort_buffer(&SortBuffer<u32>) usage. All 25 integration tests + 9 unit tests pass without modifications.
- Task 1.3: No test file changes required. Type inference handles all alloc_sort_buffer calls. `cargo test -p forge-sort --release -- --test-threads=1` → 25 passed, 0 failed.
- Task 1.6: sort_f32/sort_f32_buffer identical to sort_i32 pattern but mode=1 (FloatFlip forward) and mode=2 (IFloatFlip inverse). Test verifies total_cmp ordering via to_bits() comparison for NaN/Inf/-0.0 edge cases. 36 tests pass (11 unit + 25 integration).
- Task 1.7: 12 i32 tests + 15 f32 tests added. All pass including 16M random data, IEEE 754 specials, NaN variants, denormals, buffer API. Use `assert_bits_eq` helper for f32 (NaN != NaN). rand_chacha 0.3 with ChaCha8Rng::seed_from_u64 for deterministic RNG. 63 total tests now (11 unit + 25 existing + 12 i32 + 15 f32).
- Task 2.1: InnerParams struct refactor is pure plumbing — MSL struct + Rust #[repr(C)] struct must match layout. Both dispatch_sort() and encode_sort_pipeline() need updating (two callsites). start_shift=0, pass_count=3 preserves exact current behavior. All 63 tests pass.
- Task 2.2: Adding function-constant-guarded buffer bindings to a Metal kernel forces ALL callers to use specialized PSO compilation (newFunctionWithName:constantValues:). Even if `has_values` defaults to false, Metal's validator rejects plain `get_or_create` once the kernel references a function constant. Fix: change sort_msd_atomic_scatter and sort_inner_fused PSO compilation from `get_or_create` to `get_or_create_specialized` with `HAS_VALUES=false`. Dead code elimination confirmed — no perf impact. All 63 tests pass.
- Task 2.3: sort_inner_fused value tracking requires 3 additions: (1) buffer bindings vals_a/vals_b at buffer(4)/buffer(5), (2) src_vals/dst_vals pointer swap matching key ping-pong `(pass % 2u == 0u)`, (3) value load in tile read + value scatter alongside key scatter, both guarded by `if (has_values)`. Register array `uint vals[SORT_ELEMS]` declared inside tile loop (not outside pass loop) — scoped per tile, same as keys[]. Dead code elimination confirmed for HAS_VALUES=false path — no perf impact on existing tests.

### Verification: V1 [VERIFY] Quality checkpoint: cargo check + existing tests
- Status: PASS
- Commands: cargo check --workspace (0), cargo test -p forge-sort --release --test-threads=1 (0)
- Results: 25 passed, 0 failed (integration + doc-tests)
- Notes: cargo check produced warnings only (unused imports/vars in forge-bench, not forge-sort). All forge-sort tests clean.

### Verification: V2 [VERIFY] Quality checkpoint: full test suite
- Status: PASS
- Commands: cargo check --workspace (0), cargo test -p forge-sort --release --test-threads=1 (0)
- Results: 63 total tests — 11 unit + 25 existing u32 + 12 i32 + 15 f32 = 63 passed, 0 failed
- Notes: All forge-sort tests pass across correctness.rs, correctness_i32.rs, correctness_f32.rs. cargo check warnings are in forge-bench only (unused imports/vars), not forge-sort.

### Verification: 1.8 POC Checkpoint: verify i32/f32 sort end-to-end
- Status: PASS
- Commands: cargo test -p forge-sort --release --test-threads=1 (0) | grep -E "test result|FAILED"
- Results: 5 "test result: ok" lines, 0 FAILED
- Notes: sort_i32 and sort_f32 produce correct results. No u32 regressions. Phase 1 complete.

## Blockers

- None currently

## Next

V3 [VERIFY] Quality checkpoint: shader changes safe

## Learnings (Task Planning)

- All 25 existing v1 tests pass in --release mode (verified: `cargo test -p forge-sort --release`)
- objc2-metal 0.3.2 enables all features by default -- MTLFunctionConstantValues, MTLDataType available without extra Cargo.toml features
- gpu-query and attention-proto both have working MTLFunctionConstantValues patterns: `setConstantValue_type_atIndex` + `newFunctionWithName_constantValues_error` (reference implementations)
- forge-primitives PsoCache uses descriptor-based PSO creation with occupancy hints (maxTotalThreadsPerThreadgroup=256, threadGroupSizeIsMultipleOfThreadExecutionWidth=true) -- specialized PSO must match
- rand_chacha already in Cargo.lock from other workspace members -- just needs dev-dep in forge-sort/Cargo.toml
- Working directory for cargo commands: `/Users/patrickkavanagh/gpu_kernel/metal-forge-compute`
- 35 total tasks: 10 in Phase 1 (POC), 8 in Phase 2 (argsort/KV), 8 in Phase 3 (64-bit), 4 in Phase 4 (testing), 4 in Phase 5 (quality/PR), plus 7 [VERIFY] checkpoints
- Key dependency chain: PsoCache extension (1.1) -> SortKey+SortBuffer (1.2) -> test update (1.3) -> shader changes (1.4) -> sort methods (1.5, 1.6)
- InnerParams refactor (2.1) must happen before 64-bit pipeline (3.3) since 64-bit needs variable start_shift/pass_count
- 64-bit buffer ping-pong is highest risk area: 3 inner dispatches with alternating buf_a/buf_b arguments, must track which buffer holds final output
