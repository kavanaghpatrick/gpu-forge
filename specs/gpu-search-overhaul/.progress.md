# gpu-search-overhaul

## Original Goal

Comprehensive gpu-search profiling, accuracy, and performance overhaul. 5 issues from foreman spec analysis (see gpu-search/ai/tasks/spec/PM.md, TECH.md, QA.md, UX.md):

1. **SEARCH ACCURACY BUG (P0)**: GPU content_search_kernel returns correct byte matches but resolve_match() in orchestrator.rs maps byte_offset to wrong file when multi-file GPU batches span chunks. Fix: add CPU verification layer using memchr::memmem.

2. **SLOW TIME-TO-FIRST-RESULT**: Benchmark data shows GPU compute is <50ms total but I/O takes 33s to walk 700K files from root /. Triple I/O tax. Fix: wire existing MmapIndexCache + SharedIndexManager into orchestrator. Use mmap+bytesNoCopy for zero-copy GPU access (KB #1288: 16KB page alignment, KB #248: 0.0004ms transfer).

3. **FILESYSTEM INDEX**: Existing GSIX binary format in src/index/ is complete but unwired. Wire notify v7 + FSEvents. Channel-swap pattern.

4. **PIPELINE PROFILER**: Add Instant-based PipelineProfile with per-stage timing. P50/P95/P99 metrics. Criterion regression detection.

5. **TEST GAPS**: No test verifies resolve_match() accuracy (GAP-1). No multi-file batch chunk mapping test (GAP-2). Add grep oracle tests.

Additional strategies from KB:
- CPU/GPU hybrid dispatch: route files <64KB to CPU memchr, larger to GPU (KB #1134)
- TLB shootdown mitigation via fast page recycling (KB #595: 28% improvement)
- Apple Silicon unified memory eliminates GPUDirect Storage need (KB #1338)

## Completed Tasks
- [x] 1.1 Add memchr CPU verification module - b170e7f

## Current Phase
execution (Phase 1 in progress)

## Reality Check (BEFORE)

**Goal type**: Fix (P0 accuracy bug) + Add (index, profiler, tests)
**Reproduction**: False positives observed when searching from root `/` -- GPU byte_offset maps to wrong file in multi-file batches.

## Learnings

- P0 bug is NOT in the GPU kernel -- it's in the CPU-side byte_offset interpretation chain across 3 files (content.rs `collect_results()`, streaming.rs `search_files_with_profile()`, orchestrator.rs `resolve_match()`)
- `context_start` in GpuMatchResult has dual meaning: GPU writes `offset_in_chunk + line_start_in_64B_window`, but `line_start` only counts newlines within the local 64-byte thread window, not from chunk start. For matches >64B into a chunk, this produces incorrect line-start positions.
- The `resolve_match()` safety net (`find(pattern)` returning None on mismatch) already catches most false positives, but also discards valid matches whose byte offsets are slightly wrong.
- GSIX index infrastructure is complete (cache.rs, scanner.rs, shared_index.rs, gpu_index.rs, gpu_loader.rs) but the orchestrator never calls any of it -- the index is fully unwired.
- `turbo_search.metal` already implements deferred line counting (GPU records byte offsets only, CPU extracts lines) -- this should be the default path, per KB #1320/#1322.
- memchr crate is already in Cargo.toml -- CPU verification layer has zero new dependencies.
- Streaming pipeline (streaming.rs) is quad-buffered in structure but sequential in I/O (POC mode). True MTLIOCommandQueue overlap is Phase 2.
- Foreman analysis (PM.md, TECH.md, QA.md, UX.md) was thorough -- 4 files totaling ~108KB of analysis provided the complete root cause chain, fix strategy, test gaps, and architecture plan.
- The `ContentMatch` struct in content.rs uses `byte_offset = chunk_index * 4096 + context_start` -- the fix is to use `context_start + column` to get the actual match position instead of the (incorrect) line start.
- verify.rs: `memchr::memmem::Finder::find_iter` returns non-overlapping matches (important for patterns like "aa" in "aaaa" -- returns 0,2 not 0,1,2).
- VerifyMode::from_env() reads GPU_SEARCH_VERIFY env var -- "full", "sample", or default "off".

## Next
Task 1.2: Add accuracy test asserting every returned line contains pattern
