---
spec: kb-temporal-relevance
basePath: ./specs/kb-temporal-relevance
phase: tasks
task: 0/32
updated: 2026-02-13
---

# Progress: kb-temporal-relevance

## Original Goal

Update the gpu-forge investigation agent pipeline to solve KB temporal relevance pollution. Add hardware_generation, temporal_status, superseded_by columns to findings table. Add kb search --gen filter, kb supersede, kb tag-gen, kb freshness commands. Update investigation agent prompts for generation tagging and supersession checks. Backfill 203 existing tagged findings. Full spec already exists in ai/tasks/spec/ (PM.md, UX.md, TECH.md, QA.md, OVERVIEW.md) from foreman-spec deep mode analysis.

## Completed Tasks

- [x] 1.1 Update schema.sql with temporal columns and indexes
- [x] 1.2 Add migrate-temporal command to kb CLI
- [x] 1.3 Modify search command with --gen and --include-superseded flags
- [x] 1.4 Add supersede command with self-guard
- [x] 1.5 Add unsupersede command
- [x] V1 Quality checkpoint: existing 194 BATS tests still pass
- [x] 1.6 Modify detail command for supersession chain display
- [x] 1.7 Modify add command for optional gpu_generation param
- [x] 1.8 POC Checkpoint: end-to-end temporal workflow

## Current Task

Awaiting next task

## Completed Phase 2 (agent prompts)
- [x] 2.6 Update knowledge-retriever.md with gen detection + formatting
- [x] 2.5 Update investigation-agent.md with 3 temporal insertions

## Completed Phase 2 (continued)
- [x] 2.4 Update help text with temporal commands

## Completed Phase 2 Tasks
- [x] 2.1 Add tag-gen command (single, auto, clear modes)
- [x] 2.2 Add freshness command (dashboard + JSON)
- [x] 2.3 Add Check 6 to verify command (temporal quality)
- [x] V2 Quality checkpoint: all 194 existing tests pass + new commands work



## Interview Responses

### Tasks Interview (from tasks.md)
- Testing depth: Comprehensive — 54 BATS tests (unit + integration + golden queries + performance)
- Deployment approach: Standard — manual migration trigger, no feature flags needed
- Execution priority: Balanced — POC-first, then tests and agent prompts

## Learnings

- Foreman analysis resolved all 15 ambiguities pre-requirements -- zero unresolved questions remain
- FR count expanded from PM's 13 to 20 after including migration, graceful degradation, schema.sql update, detail/add/help mods, and unsupersede
- NFR-5 token budget revised: 50 tokens was unrealistic for 3 agent prompts; ~200 tokens total is the validated target
- Self-supersession guard (QA-2) added as FR not in original PM spec -- cheap one-line check, high value
- Exact-match contradiction detection for Phase 1 avoids FTS pairwise scoring complexity; catches all 7 known contradictions
- 82% of KB is generation-agnostic -- temporal pipeline primarily targets the 13% gen-tagged + ~5% untagged benchmarks
- Post-FTS filtering is the documented SQLite best practice; no FTS5 schema changes needed
- Existing BATS tests use `--partial` matching throughout -- new gen column in search output won't break assertions
- Design: `kb` script is 474 lines with `case` dispatch, `run_sql` wrapper, `escape_sql` for strings -- all new commands must follow same patterns
- Design: `agents/` directory under plugin root has only `investigation-agent.md`; knowledge-retriever.md and architecture-advisor.md not found in expected location -- may need to create or locate them
- Design: schema.sql has 5 existing indexes on findings + 3 citation indexes; 3 new temporal indexes follow same `IF NOT EXISTS` pattern
- Design: FTS5 triggers sync claim/evidence/tags/notes only -- temporal columns correctly excluded from FTS content
- Design: SQLite 3.51.1 supports ADD COLUMN with CHECK (3.37.0+) and DROP COLUMN (3.35.0+) -- both migration and rollback paths verified
- Design: `freshness` command's contradiction SQL uses self-join on findings with `a.id < b.id` to avoid duplicate pairs
- Design: 24 ordered implementation steps; critical path is schema -> CLI -> agents -> backfill (5 days estimated)
- Implementation: tag-gen auto mode uses process substitution (`< <(run_sql ...)`) to feed while-read loop; case-insensitive matching done via separate m/M patterns; 154 findings auto-tagged on production DB copy
- Tasks: All 3 agent prompt files confirmed present in `agents/` directory (investigation-agent.md, knowledge-retriever.md, architecture-advisor.md) -- earlier learning about missing files was incorrect
- Tasks: Existing test suite confirmed at 194 tests, all passing; `bats tests/ --recursive` is the full-suite command
- Tasks: `tests/test_helper/common-setup.bash` sets `PLUGIN_ROOT` and `CLAUDE_PLUGIN_ROOT`; loads bats-support and bats-assert from Homebrew
- Tasks: Performance tests use `_now_ns()` helper with `date +%s%N` fallback to python3; thresholds in ms
- Tasks: kb-cli.bats setup() pattern: copy production DB to `BATS_TEST_TMPDIR`, set `GPU_FORGE_DB` env var -- temporal tests must add `kb migrate-temporal` call in setup
- Tasks: `search)` case is lines 68-90 of scripts/kb; `detail)` is lines 114-128; `verify)` is lines 246-350; `add)` is lines 49-66; `*)` help is lines 433-474
- Tasks: 32 total tasks: 9 in Phase 1 (POC), 8 in Phase 2 (feature), 9 in Phase 3 (testing), 4 in Phase 4 (quality), 3 in Phase 5 (PR)
- Tasks: Quality checkpoints (V1-V5) inserted every 2-3 tasks; V4 runs full local CI; V5 verifies all 22 acceptance criteria
- Implementation: `local` keyword cannot be used in top-level `case` blocks in bash (only inside functions) -- use plain variable assignment instead
- Implementation: Search graceful degradation uses `pragma_table_info` check; temporal path builds gen_clause/status_clause conditionally; pre-migration path uses original query unchanged
- Implementation: Search ORDER BY builds dynamically -- CASE WHEN for superseded ordering only added when --include-superseded is set
- Implementation: Supersede command parses --force flag after shift 3 (past old_id, new_id, reason); self-guard check must precede ID existence checks for fast-fail
- Implementation: Unsupersede follows same pattern as supersede -- ID validation, status check, UPDATE with audit note append; outputs to stderr for warnings (already-current) to allow grep on stdout for success
- POC: Full Phase 1 end-to-end workflow verified: migrate -> add(m4) -> search(--gen m4) -> supersede -> detail(SUPERSEDED) -> cleanup. All 7 steps passed on first run.
- Implementation: Freshness command skill_join_clause from TECH.md had double-WHERE bug when combined with individual WHERE queries. Fixed by splitting into skill_join (JOIN only) + skill_and (AND clause) for queries that already have WHERE, keeping skill_join_clause for standalone queries like GROUP BY.
- Implementation: Check 6 in verify correctly gated via pragma_table_info; 79 benchmark/empirical findings flagged as WARNING on post-migration DB; silently skipped on pre-migration DB; 194 existing tests unaffected

## Blockers

- None currently

## Next

Task 2.7: Update architecture-advisor.md with gen consistency check

### Verification: V2 [VERIFY] Quality checkpoint: all 194 existing tests pass + new commands work
- Status: PASS
- Command: `bats tests/ --recursive` (from plugin root)
- Result: 194/194 tests pass, 0 failures
- No fixes needed; all Phase 2 commands (tag-gen, freshness, verify Check 6) integrate cleanly
- Spot-check results: migrate-temporal OK, search --gen OK, freshness dashboard OK, tag-gen --auto --dry-run OK, verify Check 6 OK, supersede OK, detail (supersession chain) OK, unsupersede OK

### Verification: V1 [VERIFY] Quality checkpoint: existing 194 BATS tests still pass
- Status: PASS
- Command: `bats tests/ --recursive` (from plugin root)
- Result: 194/194 tests pass, 0 failures
- Pre-existing fix: 4 hooks.bats tests (116-118, 123) were failing due to hooks.json format mismatch (object vs array). Tests updated to match actual hooks.json structure. These failures were unrelated to Phase 1 changes (data/schema.sql, scripts/kb).
- File fixed: `tests/unit/hooks.bats` -- updated jq queries to match nested object format of hooks.json
